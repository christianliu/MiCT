%section
	.notice= flash[:success]
	.notice= flash[:error]

	%ul.listing#info

	/ = select_tag('search_t', options_from_collection_for_select(Technology.all, "id", "name"), multiple: true, class: "select2")

	= search_form_for @q do |f|
		= f.label :name_cont, "Name contains: "
		= f.text_field :name_cont
		= f.label :size_gteq, "Size is greater than: "
		= f.text_field :size_gteq
		= f.label :size_lteq, "Size is less than: "
		= f.text_field :size_lteq
		= f.submit

%section.map#map

:javascript

	var map = L.mapbox.map('map', 'examples.h186knp8').setView([-33.93, 18.42], 10);
	

	var myLayer = null;

	// search
	$('#company_search').on('submit', function(e) {
		e.preventDefault();

		fetchMarkers({
			onComplete: function(data) {
				// once the data has been fetched

				// clear all markers
				myLayer.clearLayers();

				// add markers from data (if there are any?)
				placeMarkers(myLayer, data);

				if (data.length > 0) {
					setTimeout( function() {
					map.fitBounds(myLayer.getBounds());
					}, 50);
				}
				
			},
			data: $('#company_search').serialize()
		});
	});


	var fetchMarkers = function(args) {
		$.ajax({
			type: "GET",
			data: args.data,
			url: "/companies",
			dataType: "json",
			success: args.onComplete
		});
	};

	var placeMarkers = function(layer, data) {

		layer.setGeoJSON(data);
		var info = document.getElementById('info');

		// Iterate through each feature layer item, build a
		// marker menu item and enable a click event that pans to + opens
		// a marker that's associated to the marker item.
		layer.eachLayer(function(marker) {
		var link = info.appendChild(document.createElement('li'));
		link.className = 'item';
		link.href = '#';

		// Populate content from each markers object.
		link.innerHTML = marker.feature.properties.title +
		  '' + marker.feature.properties.description + '';
		link.onclick = function() {
		  if (/active/.test(this.className)) {
			this.className = this.className.replace(/active/, '').replace(/\s\s*$/, '');
		  } else {
			var siblings = info.getElementsByTagName('li');
			for (var i = 0; i < siblings.length; i++) {
			  siblings[i].className = siblings[i].className
				.replace(/active/, '').replace(/\s\s*$/, '');
			};
			this.className += ' active';

			// When a menu item is clicked, animate the map to center
			// its associated marker and open its popup.
			map.panTo(marker.getLatLng());
			marker.openPopup();
		  }

		};
		});

	};

	myLayer = L.mapbox.featureLayer().addTo(map);

	fetchMarkers({
		onComplete: function(data) {
			placeMarkers(myLayer, data);
			setTimeout( function() {
			map.fitBounds(myLayer.getBounds());
			}, 50);
		}
	});

